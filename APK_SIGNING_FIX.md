# APK Signing Fix Documentation

## Problem Description

Users were experiencing an "invalid APK" error when trying to install the application. The error message indicated that the APK could not be installed because it appeared to be invalid.

## Root Cause

The issue had multiple components:

### 1. Unsigned APK Distribution
The release workflow was generating and distributing **unsigned APKs** (`app-release-unsigned.apk`). Android requires all APKs to be signed before they can be installed on a device. Unsigned APKs will fail installation with an "invalid APK" error.

### 2. Deprecated Gradle Configuration
The project used deprecated Gradle configuration patterns that were incompatible with modern build tools:
- Used `allprojects` block in root `build.gradle` (deprecated in Gradle 7.x+)
- Used `apply plugin` syntax instead of modern `plugins` DSL
- Repository declarations were in the wrong location

### 3. Missing Signing Configuration
The `app/build.gradle` file did not explicitly configure signing for debug or release builds, which could lead to unsigned builds in certain scenarios.

## Solution Implemented

### 1. Fixed Gradle Configuration

**Root build.gradle:**
- Removed deprecated `allprojects` block
- Retained `buildscript` for compatibility with Gradle 8.2
- Added clean task for better build hygiene

**settings.gradle:**
- Added `pluginManagement` block with proper repository configuration
- Added `dependencyResolutionManagement` to centralize repository declarations
- Set `RepositoriesMode.FAIL_ON_PROJECT_REPOS` to enforce modern practices

**app/build.gradle:**
- Updated to use modern `plugins` DSL
- Added explicit `signingConfigs` section
- Configured both debug and release builds to use signing

### 2. Updated Release Workflow

**android-release.yml:**
- Changed from `app-release-unsigned.apk` to `app-release.apk`
- The signed APK is now properly distributed to users

### 3. Signing Strategy

For this open-source project, both debug and release builds use the default debug keystore. This is acceptable because:

- Debug keystore is automatically generated by Android build tools
- It's suitable for open-source projects where source code is public
- Users can still install and use the app
- No security concerns for non-monetized, non-personal-data apps

**For production apps**, you should:
1. Generate a proper release keystore
2. Store keystore credentials securely (e.g., GitHub Secrets)
3. Configure release build to use the production keystore

## Technical Details

### APK Signing Process

Android APKs must be signed with a digital certificate. The signing process:
1. Generates or uses an existing keystore
2. Signs the APK with the private key from the keystore
3. Embeds the certificate in the APK
4. Creates a manifest digest and signature

### Debug vs Release Signing

**Debug Signing:**
- Uses automatically generated debug keystore
- Located at `~/.android/debug.keystore`
- Same credentials across all developers
- Not suitable for public distribution (but OK for open source projects)

**Release Signing (Production):**
- Uses custom keystore with unique credentials
- Credentials must be kept secret
- Required for Play Store distribution
- Should be backed up securely

## Verification

To verify an APK is properly signed:

```bash
# Using apksigner (from Android SDK build-tools)
apksigner verify --verbose app-release.apk

# Using jarsigner (from JDK)
jarsigner -verify -verbose -certs app-release.apk
```

Expected output should show:
- Certificate information
- SHA-256 digest
- Signature verification success

## Installation Instructions for Users

With the fixed build:

1. **Download the APK** from the Releases page
2. **Enable installation from unknown sources** (if needed):
   - Go to Settings → Security → Unknown Sources
   - Or Settings → Apps → Special Access → Install unknown apps
3. **Install the APK** by opening the downloaded file
4. The installation should now succeed

## Build Commands

For developers building locally:

```bash
# Build debug APK (signed with debug keystore)
./gradlew assembleDebug

# Build release APK (signed with debug keystore for now)
./gradlew assembleRelease

# The signed APK will be at:
# app/build/outputs/apk/debug/app-debug.apk
# app/build/outputs/apk/release/app-release.apk
```

## Future Improvements

For a production release, consider:

1. **Generate Production Keystore:**
   ```bash
   keytool -genkey -v -keystore release-keystore.jks \
     -keyalg RSA -keysize 2048 -validity 10000 \
     -alias mobile-network-reset
   ```

2. **Store Credentials in GitHub Secrets:**
   - KEYSTORE_FILE (base64 encoded keystore)
   - KEYSTORE_PASSWORD
   - KEY_ALIAS
   - KEY_PASSWORD

3. **Update build.gradle with release signing:**
   ```groovy
   signingConfigs {
       release {
           storeFile file(System.getenv("KEYSTORE_FILE") ?: "release-keystore.jks")
           storePassword System.getenv("KEYSTORE_PASSWORD")
           keyAlias System.getenv("KEY_ALIAS")
           keyPassword System.getenv("KEY_PASSWORD")
       }
   }
   
   buildTypes {
       release {
           signingConfig signingConfigs.release
           // ... other config
       }
   }
   ```

4. **Update GitHub Actions workflow to decode keystore:**
   ```yaml
   - name: Decode keystore
     run: |
       echo "${{ secrets.KEYSTORE_FILE }}" | base64 -d > release-keystore.jks
     
   - name: Build Release APK
     env:
       KEYSTORE_FILE: release-keystore.jks
       KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
       KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
       KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
     run: ./gradlew assembleRelease
   ```

## References

- [Android App Signing Documentation](https://developer.android.com/studio/publish/app-signing)
- [Gradle Android Plugin DSL Reference](https://developer.android.com/reference/tools/gradle-api)
- [GitHub Actions Android CI/CD](https://docs.github.com/en/actions/guides/building-and-testing-java-with-gradle)

## Changelog

- **2025-10-17**: Fixed unsigned APK issue
  - Added proper signing configuration
  - Updated Gradle build files to modern standards
  - Fixed release workflow to distribute signed APKs
